<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bitcoin identity verifier</title>

    <meta charset="UTF-8">
    <meta name="description" content="Verify the identity of owners of bitcoin addresses"/>
    <meta name="keywords"
          content="data, signature, anchoring, Bitcoin, blockchain, proof, verify, timestamp, existence, integrity, identity"/>
    <meta name="author" content="Woleet SAS"/>

    <script src="node_modules/woleet-weblibs/dist/woleet-weblibs.min.js"></script>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-74211511-3', 'auto');
        ga('send', 'pageview');
    </script>
</head>

<body>

<div class="page-header" style="background: url('image/header.jpg'); margin-top: 0;">
    <div class="container">
        <h1 style="color: #258C90;">
            Bitcoin identity verifier<br>
            <small style="color: #b3b8c3;">Verify the identity of owners of Bitcoin addresses</small>
        </h1>
    </div>
</div>

<div class="container">

    <span class="glyphicon glyphicon-circle-arrow-right"></span>
    verify the <strong>ownership</strong> of a Bitcoin address<br>
    <span style="font-size: 12px;">by using the owner's identity URL (see <a href="https://medium.com/@woleet/beyond-data-anchoring-bee867d9be3a">signature anchoring</a> extension to Chainpoint 1.x)</span>

    <br><br>

    <span class="glyphicon glyphicon-circle-arrow-right"></span>
    get the <strong>identity</strong> of the owner of a Bitcoin address<br>
    <span style="font-size: 12px;">by extracting it from the TLS certificate of the owner's identity URL</span>

    <br><br>

    <small><a href="/proof">< proof verification page</a></small>

</div>

<br>

<div class="container">
    <div>
        <div class="form-group">
            <input type="text" class="form-control" id="pubKey" placeholder="Bitcoin address" name="pubKey">
        </div>
        <div class="form-group">
            <input type="text" class="form-control" id="identityURL" placeholder="Identity URL" name="identityURL">
        </div>
        <button type="button" class="btn btn-default" id="btnSub" onclick="checkIdentity()"
                style="display: flex;  margin: 0 auto;">
            Submit
        </button>
    </div>

    <br>

    <div class="alert alert-danger" id="certErrorContainer" style="display: none">
        TLS certificate error:<br>
        <small id="certError"></small>
    </div>

    <div class="container" id="validationZone" style="display: none">
        <h4>The owner of <a id="url"></a>'s TLS certificate</h4>
        <h3><span class="label label-info" id="certDetailSubject"></span></h3>
        <div>issued by <span class="label label-info" id="certDetailIssuer"></span></div>

        <h4>is the owner of the bitcoin address</h4>
        <h3><span class="label label-info" id="address"></span></h3>
    </div>

    <div class="container" id="statusZone" style="display: none">
        <span class="glyphicon glyphicon-circle-arrow-right"></span>
        Bitcoin address ownership: <span id="idStatus"></span>
        <br><br>
        <span class="glyphicon glyphicon-circle-arrow-right"></span>
        Identity URL certificate: <span id="certStatus"></span>
    </div>

</div>

<script>

    function getParameterByName(name) {
        var match = new RegExp('[?&]' + name + '=([^&]*)', 'i').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }

    function getElt(id) {
        return document.getElementById(id);
    }

    function getElts(list) {
        return list.reduce((acc, key) => (acc[key] = getElt(key), acc), {});
    }

    var elts = getElts(["identityURL", "pubKey", "idStatus", "certStatus",
        "validationZone", "statusZone", "btnSub", "certDetailSubject", "certDetailIssuer",
        "address", "url", "certErrorContainer", "certError"]);

    elts.identityURL.value = getParameterByName("identityURL");
    elts.pubKey.value = getParameterByName("pubKey");

    function formatCertField(o) {
        return [o.CN, o.O, o.L, o.ST, o.C].join(' ')
    }

    function checkIdentity() {
        var i = elts.identityURL.value;
        var k = elts.pubKey.value;

        elts.statusZone.style.display = 'none';
        elts.validationZone.style.display = 'none';
        elts.certErrorContainer.style.display = 'none';

        Promise.all([
            woleet.signature.validateIdentity(i, k)
                .catch((e) => {
                    return {error: 'failed to verify the ownership of the bitcoin address by the identity URL'};
                }),
            woleet._getJSON('/cert?target=' + i)
                .catch((e) => {
                    return {error: 'failed to verify the TLS certificate'};
                })
        ])
            .then((arr) => {
                var vIdentityURL = arr[0];
                var vCertificate = arr[1];

                if (!vCertificate.error && !vIdentityURL.error)
                    elts.validationZone.style.display = 'block';
                else
                    elts.statusZone.style.display = 'block';

                if (!vIdentityURL.error) {
                    if (vIdentityURL) {
                        elts.idStatus.innerText = 'valid';
                        elts.idStatus.style = 'color: green';
                    } else {
                        elts.idStatus.innerText = 'invalid';
                        elts.idStatus.style = 'color: red';
                    }
                    elts.address.innerText = k;
                    elts.url.innerText = i;
                    elts.url.setAttribute('href', i);
                } else {
                    elts.idStatus.innerText = 'invalid: ' + vIdentityURL.error;
                    elts.idStatus.style = 'color: red';
                }

                if (!vCertificate.error) {
                    if (vCertificate.authorized) {
                        elts.certStatus.innerText = 'valid';
                        elts.certStatus.style = 'color: green';
                    } else {
                        elts.certStatus.innerText = 'invalid';
                        elts.certStatus.style = 'color: red';
                    }

                    if (!vCertificate.certificates.length) return;

                    var cert = vCertificate.certificates[0];
                    elts.certDetailIssuer.innerText = formatCertField(cert.issuer);
                    elts.certDetailSubject.innerText = formatCertField(cert.subject);
                } else {
                    elts.certStatus.innerText = 'invalid: ' + vCertificate.error;
                    elts.certStatus.style = 'color: red';
                }
            })
            .catch((e) => {
                elts.certErrorContainer.style.display = 'block';
                elts.certError.innerText = e;
            })
    }
</script>

<span style="color: #b3b8c3; font-size: 10px; position: absolute; top: 5px;right: 5px;">
    This tool is gracefully provided to <a href="https://github.com/woleet/btcproof.info">
    the community</a> by <a href="https://woleet.io">Woleet</a>
</span>

</body>
</html>
