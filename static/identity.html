<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bitcoin identity verifier</title>

    <meta charset="UTF-8">
    <meta name="description" content="Verify the identity of owners of Bitcoin addresses"/>
    <meta name="keywords"
          content="data, signature, anchoring, Bitcoin, blockchain, proof, verify, timestamp, existence, integrity, identity"/>
    <meta name="author" content="Woleet SAS"/>

    <script src="node_modules/woleet-weblibs/dist/woleet-weblibs.min.js"></script>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

</head>

<body>

<div class="page-header" style="background: url('image/header.jpg'); margin-top: 0;">
    <div class="container">
        <h1 style="color: #258C90;">
            Bitcoin identity verifier<br>
            <small style="color: #b3b8c3;">Verify the identity of owners of Bitcoin addresses</small>
        </h1>
    </div>
</div>

<div class="container">
    <span class="glyphicon glyphicon-circle-arrow-right"></span>
    verify the <strong>ownership</strong> of a Bitcoin address<br>
    <span style="font-size: 12px;">by using the owner's identity URL (see <a href="https://medium.com/@woleet/beyond-data-anchoring-bee867d9be3a">signature anchoring</a> extension to Chainpoint 1.x)</span>
    <br><br>
    <span class="glyphicon glyphicon-circle-arrow-right"></span>
    get the <strong>identity</strong> of the owner of a Bitcoin address<br>
    <span style="font-size: 12px;">by extracting it from the TLS certificate of the owner's identity URL</span>
</div>

<br>

<div class="container">
    <div>
        <div class="form-group">
            <input type="text" class="form-control" id="pubkey" placeholder="Bitcoin address" name="pubkey">
        </div>
        <div class="form-group">
            <input type="text" class="form-control" id="identityURL" placeholder="Identity URL" name="identityURL">
        </div>
        <button type="button" class="btn btn-default" id="btnSub" onclick="checkIdentity()"
                style="display: flex;  margin: 0 auto;">
            Submit
        </button>
    </div>

    <br>

    <div class="alert alert-danger" id="certErrorContainer" style="display: none">
        TLS certificate error:<br>
        <small id="certError"></small>
    </div>

    <div class="container" id="validationZone" style="display: none">
        <h4>The owner of the URL <a id="url"></a> TLS certificate</h4>
        <h3><span class="label label-info" id="certDetailSubject"></span></h3>
        <div>issued by <span class="label label-info" id="certDetailIssuer"></span></div>

        <h4>is the owner of the bitcoin address</h4>
        <h3><span class="label label-info" id="address"></span></h3>

        <br>

        <span class="glyphicon glyphicon-circle-arrow-right"></span>
        Identity status : <span id="idStatus"></span>
        <br><br>
        <span class="glyphicon glyphicon-circle-arrow-right"></span>
        Certificate status : <span id="certStatus"></span>
    </div>

</div>

<script>

    function getParameterByName(name) {
        var match = new RegExp('[?&]' + name + '=([^&]*)', 'i').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }

    function getElt(id) {
        return document.getElementById(id);
    }

    function getElts(list) {
        return list.reduce((acc, key) => (acc[key] = getElt(key), acc), {});
    }

    var elts = getElts(["identityURL", "pubkey", "idStatus", "certStatus",
        "validationZone", "btnSub", "certDetailSubject", "certDetailIssuer",
        "address", "url", "certErrorContainer", "certError"]);

    elts.identityURL.value = getParameterByName("identityURL");
    elts.pubkey.value = getParameterByName("pubKey");

    function formatCertField(o) {
        return [o.CN, o.O, o.L, o.ST, o.C].join(' ')
    }

    function checkIdentity() {
        var i = elts.identityURL.value;
        var k = elts.pubkey.value;

        elts.btnSub.style.display = 'none';

        Promise.all([
            woleet.signature.validateIdentity(i, k)
                .catch((e) => {
                    throw 'Failed to validate identity';
                }),
            woleet._getJSON('/cert?target=' + i)
                .catch((e) => {
                    throw 'Failed to validate certificate';
                })
        ])
            .then((arr) => {
                var vIdentity = arr[0];
                if (!vIdentity.error) {
                    elts.validationZone.style.display = 'block';
                    console.log(vIdentity);
                    elts.idStatus.innerText = vIdentity ? 'valid' : 'invalid';
                    elts.address.innerText = k;
                    elts.url.innerText = i;
                    elts.url.setAttribute('href', i);
                }
                return arr[1];
            })
            .then((vCertificate) => {
                console.log(vCertificate);
                if (!vCertificate.error) {
                    if (vCertificate.authorized) elts.certStatus.innerText = 'valid';
                    else elts.certStatus.innerText = 'invalid';

                    if (!vCertificate.certificates.length) return;

                    var cert = vCertificate.certificates[0];
                    elts.certDetailIssuer.innerText = formatCertField(cert.issuer);
                    elts.certDetailSubject.innerText = formatCertField(cert.subject);
                }
            })
            .catch((e) => {
                elts.certErrorContainer.style.display = 'block';
                elts.certError.innerText = e;
            })
    }
</script>

<span style="color: #b3b8c3; font-size: 10px; position: absolute; top: 5px;right: 5px;">
    This tool is gracefully provided to <a href="https://github.com/woleet/btcproof.info">
    the community</a> by <a href="https://woleet.io">Woleet</a>
</span>

</body>
</html>
